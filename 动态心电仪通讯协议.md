动态心电仪通讯协议（外部）

# 概述

本文档为动态心电仪数据设备（v4.5）通用数据通讯协议，后续硬件版本会根据功能要求和实际测试使用环境进行修改，仅供参考。

## **1.** 通讯通道说明

蓝牙会使用 2 个蓝牙服务共 3 个通道进行数据交互。

UUID：2A37 WRITE |负责从上位机接收命令

UUID：2A38 NOTIFY |负责心电数据以外的数据应答

UUID：2A39 NOTIFY |负责心电数据发送

下图为蓝牙广播相关信息项

![img](file:///C:\Users\lxy\AppData\Local\Temp\ksohtml24752\wps1.png) 

下图为蓝牙通道信息配置

![img](file:///C:\Users\lxy\AppData\Local\Temp\ksohtml24752\wps2.png) 

## **2. ECG** 数据和设备信息数据结构说明（后续可增补）

ECG 数据分为本地存储和蓝牙发送两种数据格式，设备信息数据仅通过蓝牙命令从蓝牙通讯中获取。

### **2.1 ECG** 数据本地存储数据格式

**2.1.1 ECG** 数据数据头

| 字节 1~6            | 字节 7~12           | 字节 13                                                      | 字节 14~32   |
| ------------------- | ------------------- | ------------------------------------------------------------ | ------------ |
| SN 码               | 开始时间            | 错误警告                                                     | 保留的数据位 |
| 16 进制 12 位 SN 码 | 16 进制：年月日分秒 | 1：数据写入超时2：心电数据存储失败3：设备初始化失败4：存储已满5：设备停机6：SN 写入失败7：电池电量低 |              |

注：

1、 数据头为所有存储的 ECG.bin 数据文件开头，数据头结束后紧跟的即为心电数据。

2、 关于开始时间的解析说明

例：如显示为 0x1801020c0000，则实际开始时间为 24 年 1 月 2 号 12 点 0 分 0 秒。

**2.1.2 ECG** 数据心电数据单元

| 字节 1                            | 字节2 | 字节3 | 字节4 | 字节5  | 字节6 | 字节7 | 字节8 | 字节 9         |
| --------------------------------- | ----- | ----- | ----- | ------ | ----- | ----- | ----- | -------------- |
| 状态位                            | ECG1  | ECG2  | ECG3  | ECG2&3 |       |       |       |                |
| 0x0X:包含各类标记信息，按位标记。 | 高 8  | 中 8  | 低 8  | 高 8   | 中 8  | 高 8  | 中 8  | 低左 4+ 低左 4 |

注：

1、 心电数据单元格式只适配于设备本地数据存储 ECG.bin 文件。

2、 ECG1、ECG2 和 ECG3 分别代表三个导联各自的心电数据，每个导联 3 字节。ECG2&3 中，是只取 ECG2 低 8 位中高位的 4 个 bit 和 ECG3 低 8 位中高位的 4 个 bit 合在一起，使用时需要拆开重新合并回 ECG2 和 ECG3 中，缺失的 4bit 可用 0 补齐。

3、 状态位说明

| MSB  |      |      |      |      |      |                | LSB      |
| ---- | ---- | ---- | ---- | ---- | ---- | -------------- | -------- |
| 保留 | 保留 | 保留 | 保留 | 保留 | 保留 | 通道标志       | 通道标志 |
|      |      |      |      |      |      | 00：多通道竖贴 |          |

### **2.2 ECG** 数据蓝牙发送数据格式 **UUID:2A39**

| 字节 1                            | 字节 2 | 字节 3 | 字节 4 |        |         |
| --------------------------------- | ------ | ------ | ------ | ------ | ------- |
| 状态位                            | ECG1   |        |        |        |         |
| 0x0X:包含各类标记信息，按位标记。 | 高 8   | 中 8   | 低 8   |        |         |
| 字节 5                            | 字节 6 | 字节 7 | 字节 8 | 字节 9 | 字节 10 |
| ECG2                              |        |        | ECG3   |        |         |
| 高 8                              | 中 8   | 低 8   | 高 8   | 中 8   | 低 8    |

注：

1、 ECG 蓝牙数据单元格式只应用于蓝牙传输心电数据。

2、 ECG1、ECG2 和 ECG3 分别代表三个导联各自的心电数据，每个导联 3 字节。

3、 ECG 蓝牙数据只会通过 UUID：2A39 通道发送，与其他蓝牙数据或反馈信号分开。

4、 状态位说明

| MSB  |      |      |      |      |      |                | LSB      |
| ---- | ---- | ---- | ---- | ---- | ---- | -------------- | -------- |
| 保留 | 保留 | 保留 | 保留 | 保留 | 保留 | 通道标志       | 通道标志 |
|      |      |      |      |      |      | 00：多通道竖贴 |          |



### **2.3** 设备信息数据格式 **UUID:2A38**

| 字节 1                                     | 字节 2        | 字节 3               | 字节 4         | 字节 5                                                       |         |
| ------------------------------------------ | ------------- | -------------------- | -------------- | ------------------------------------------------------------ | ------- |
| 起始位                                     | 标志位        | ADS 工作状态         | 电池电量百分比 | 错误标志                                                     |         |
| 0xFA                                       | 0x20 设备信息 | 1：采集中0：停止工作 | 0~100 十六进制 | 1：数据写入超时2：心电数据存储失败3：设备初始化失败4：存储已满5：设备停机6：SN 写入失败7：电池电量低0：设备无问题 |         |
| 字节 6                                     | 字节 7        | 字节 8               | 字节 9         | 字节 10                                                      | 字节 11 |
| 年                                         | 月            | 日                   | 时             | 分                                                           | 秒      |
| 开始采集时间，无有效数据且采集未开始则为 0 |               |                      |                |                                                              |         |
| 字节 12                                    | 字节 13       | 字节 14              | 字节 15        | 字节 16                                                      | 字节 17 |
| 设备 MAC 地址：6 位                        |               |                      |                |                                                              |         |
|                                            |               |                      |                |                                                              |         |
| 字节 18                                    | 字节 19       | 字节 20              |                |                                                              |         |
| 嵌入式代码版本号：2 位                     |               | 结束位               |                |                                                              |         |
| 0x04                                       | 0x05          | 0xFB                 |                |                                                              |         |

注：

1、 设备信息数据只应用于蓝牙通讯，且在数据请求命令收到时发送，不会存储于本地。

2、 请求设备信息数据通过 0xFA0400FB 命令请求。

## **3.** 蓝牙控制命令 **UUID**：**2A37**

命令均使用 16 进制，蓝牙命令下发只有 2A37 一个通道

### **3.1 ECG** 采集控制 **0x01**

| 字节 1             | 字节 2   | 字节 3                                       | 字节 4             | 字节 5 | 字节 6 |
| ------------------ | -------- | -------------------------------------------- | ------------------ | ------ | ------ |
| 起始位             | 控制命令 |                                              | 附加信息：开始时间 |        |        |
| 0xFA               | 0x01     | 0x01 开始采集0x00 停止采集（后面时间可不加） | 年                 | 月     | 日     |
| 字节 7             | 字节 8   | 字节 9                                       | 字节 10            |        |        |
| 附加信息：开始时间 |          | 结束位                                       |                    |        |        |
| 时                 | 分       | 秒                                           | 0xFB               |        |        |

注：

1、 开始采集命令会删除 ECG.bin 文件，清除旧数据。

2、 该命令会收到握手应答，当收到握手应答代表命令已正式执行或启动失败，才可进行下一步命令发送。

3、 开始时间需转换成 16 进制发送。

4、 发送停止采集命令可不加时间信息，直接以 0xFB 结尾

### **3.2** 蓝牙 **ECG** 数据传输 **0x02**

| 字节 1 | 字节 2   | 字节 3                              | 字节 4 |
| ------ | -------- | ----------------------------------- | ------ |
| 起始位 | 控制命令 |                                     | 结束位 |
| 0xFA   | 0x02     | 0x01 开始蓝牙传输 0x00 停止蓝牙传输 | 0xFB   |

注：

1、 开始蓝牙传输会从当前即时的 ECG 数据开始传输，如设备未开始采集，则不会收到蓝牙数据而是从 2A38 通道收到采集未开始警告信号。

2、 停止传输不会停止 ECG 数据采集。

3、 蓝牙传输与否不会影响 ECG 数据存储于本地中。

### **3.3** 主动删除 **ECG** 文件 **0x03**

| 字节 1 | 字节 2                            | 字节 3 | 字节 4 |
| ------ | --------------------------------- | ------ | ------ |
| 起始位 | 控制命令                          | 保留   | 结束位 |
| 0xFA   | 0x03：删除设备保存的 ECG.bin 文件 | 0x00   | 0xFB   |

注：

1、 该命令用于删除保存的 ECG 文件，采集中该命令无效。

2、 执行文件删除时设备指示灯将暂时熄灭，删除完成后重新亮起。

#### **3.4** 蓝牙请求设备信息 **0x04**

| 字节 1 | 字节 2             | 字节 3 | 字节 4 |
| ------ | ------------------ | ------ | ------ |
| 起始位 | 控制命令           | 保留   | 结束位 |
| 0xFA   | 0x04：请求设备信息 | 0x00   | 0xFB   |

注：该命令用于请求设备信息数据单元，请求后设备信息数据会从 2A38 通道返回。

## **4.** 蓝牙应答信号 **UUID**：**2A38**

### **4.1** 开始采集命令握手信号

| 字节 1 | 字节 2                        | 字节 3               | 字节 4 |
| ------ | ----------------------------- | -------------------- | ------ |
| 起始位 | 标志位                        | 状态应答             | 结束位 |
| 0xFA   | 0x14 接收开始采集命令响应信号 | 0x00：成功0x01：失败 | 0xFB   |

注：该单元只应用于蓝牙通知，不会存储进设备本地。

### **4.2** 电池低电量警告信号

| 字节 1 | 字节 2              | 字节 3 | 字节 4 |
| ------ | ------------------- | ------ | ------ |
| 起始位 | 标志位              | 保留   | 结束位 |
| 0xFA   | 0x11 电池电量低信号 | 0x00   | 0xFB   |

| 字节 1 | 字节 2                  | 字节 3 | 字节 4 |
| ------ | ----------------------- | ------ | ------ |
| 起始位 | 标志位                  | 保留   | 结束位 |
| 0xFA   | 0x13 采集未开始警告信号 | 0x00   | 0xFB   |

注：该单元只应用于蓝牙通知，且在检测到低电量时发送。当蓝牙连接时接收到该警告，则电池电量极低，系统即将停止采集并关机，相关错误标志 7 会存储于 ECG.bin 文件中。

### **4.3** 存储已满采集停止警告信号

| 字节 1 | 字节 2                    | 字节 3 | 字节 4 |
| ------ | ------------------------- | ------ | ------ |
| 起始位 | 标志位                    | 保留   | 结束位 |
| 0xFA   | 0x12 存储空间已满警告信号 | 0x00   | 0xFB   |

注：该单元只应用于蓝牙通知，且在检测到存储已满时发送。当蓝牙连接时接收到该警告，设备本地存储出现意外占用，相关错误标志 2 或 4 会存储于 ECG.bin 文件中。

### **4.4** 采集未开始警告信号

注：

该单元只应用于蓝牙通知，且请求蓝牙发送 ECG 数据但设备并未开始采集时发送。不会存储进设备本地。

### **2.**保留系统其他类型错误警报